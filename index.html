<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KANTHERA</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0B1220; --card:#0f172a; --muted:#94a3b8; --line:#1f2937; --fg:#e5e7eb; --brand:#3b82f6; --ok:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit;text-decoration:none}
hr{border:0;height:1px;background:var(--line);margin:12px 0}

.container{max-width:1180px;margin:0 auto;padding:20px}
.header{display:flex;gap:14px;align-items:center;padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);z-index:10}
.logo{display:flex;align-items:center;gap:10px;font-weight:700}
.logo-badge{width:28px;height:28px;border-radius:8px;background:#3b82f6;display:grid;place-content:center;font-weight:800}
.nav{margin-left:auto;display:flex;gap:16px}
.nav a{padding:.45rem .7rem;border-radius:8px}
.nav a.active{background:rgba(148,163,184,.14)}
.btn{background:var(--brand);border:none;border-radius:8px;color:#fff;padding:.55rem .9rem;cursor:pointer;font-weight:600}
.btn-outline{border:1px solid var(--line);background:transparent;border-radius:8px;color:#cbd5e1;padding:.55rem .9rem;cursor:pointer}
.btn-danger{background:#ef4444;border:none;border-radius:8px;color:#fff;padding:.42rem .7rem;cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.hstack{display:flex;gap:10px;align-items:center}
.vstack{display:flex;flex-direction:column;gap:6px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 10px}
.subtle{color:var(--muted)}
.badge{display:inline-block;background:rgba(148,163,184,.12);border:1px solid var(--line);border-radius:999px;padding:.18rem .52rem;color:var(--muted);font-size:12px}
.kpi{font-size:24px;font-weight:700}

/* site cards */
.sitecard{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:border .15s}
.sitecard:hover{border-color:#2a3b5a}

/* table */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
.table thead th{color:var(--muted);font-weight:600}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal-backdrop.show{display:flex}
.modal{width:min(880px,96vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 20px 70px rgba(0,0,0,.5)}
.modal h3{margin:0 0 14px 0}
.modal .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
.modal .col-span-2{grid-column:1 / -1}
.modal footer{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
input,select,textarea{width:100%;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:.6rem .7rem;border-radius:10px}
select{background:#0b1220}
.help{font-size:12px;color:var(--muted)}
.alert{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.4);padding:10px;border-radius:8px}
.pill-ok{color:#22c55e}
.pill-bad{color:#ef4444}
</style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-badge">K</div>
      KANTHERA
      <span class="subtle">Tu costruisci. Noi semplifichiamo.</span>
    </div>
    <nav class="nav">
      <a href="#/dashboard" id="lnkDash">Dashboard</a>
      <a href="#/sites" id="lnkSites">Sites</a>
      <a href="#/workers" id="lnkWorkers">Workers</a>
      <a href="#/pos" id="lnkPos">POS</a>
      <a href="#/ocr" id="lnkOcr">OCR</a>
    </nav>
  </header>

  <main class="container" id="app"></main>

  <!-- Modal: Nuovo Cantiere -->
  <div id="siteModal" class="modal-backdrop">
    <div class="modal">
      <h3>Nuovo cantiere</h3>
      <div class="grid">
        <div class="col-span-2">
          <label>Nome</label>
          <input id="m_site_name" placeholder="Es. Sede Cliente Verdi – Piano 3">
          <div class="help">Inserisci un nome chiaro del cantiere.</div>
        </div>
        <div class="col-span-2">
          <label>Indirizzo</label>
          <input id="m_site_address" placeholder="Via ... , Città">
        </div>
        <div>
          <label>Data inizio</label>
          <input id="m_site_start" type="date">
        </div>
        <div>
          <label>Data fine (opz.)</label>
          <input id="m_site_end" type="date">
        </div>
        <div>
          <label>Cliente (opz.)</label>
          <input id="m_site_client" placeholder="Ragione sociale">
        </div>
        <div>
          <label>Email CSE (opz.)</label>
          <input id="m_site_cse_email" type="email" placeholder="nome@esempio.it">
        </div>
      </div>
      <footer>
        <button id="m_cancel" class="btn-outline">Annulla</button>
        <button id="m_create" class="btn">Crea</button>
      </footer>
    </div>
  </div>

<script>
/* ------------ CONFIG ------------ */
const API = (window.API_BASE || 'https://kanthera-backend.onrender.com/api'); // <-- cambia se serve
const qs  = (s,el=document)=>el.querySelector(s);
const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
const STATE = { sites:[], workers:[], company:{} };

/* ------------ NAV ------------ */
function setActive(){
  const h = location.hash||'#/dashboard';
  for (const a of qsa('.nav a')) a.classList.toggle('active', a.getAttribute('href')===h);
}
window.addEventListener('hashchange', ()=>{ setActive(); router(); });

/* ------------ ROUTER ------------ */
async function router(){
  const app = qs('#app');
  const hash = location.hash || '#/dashboard';

  if (!STATE.sites.length)   { STATE.sites   = await fetch(`${API}/sites`).then(r=>r.json()).catch(()=>[]); }
  if (!STATE.workers.length) { STATE.workers = await fetch(`${API}/workers`).then(r=>r.json()).catch(()=>[]); }
  if (!STATE.company.name)   { STATE.company = await fetch(`${API}/company`).then(r=>r.json()).catch(()=>({})); }

  if (hash.startsWith('#/sites/')){
    const id = hash.split('/')[2];
    renderSiteDetail(app, id);
  } else if (hash==='#/sites'){
    renderSites(app);
  } else if (hash==='#/workers'){
    renderWorkers(app);
  } else if (hash==='#/pos'){
    renderPOS(app);
  } else if (hash==='#/ocr'){
    renderOCR(app);
  } else {
    renderDashboard(app);
  }
}

/* ------------ VIEWS ------------- */
function renderDashboard(app){
  app.innerHTML = `
    <div class="section-title">
      <h2>Dashboard</h2>
      <div class="hstack">
        <button class="btn" id="btnNewSite">+ New Site</button>
      </div>
    </div>

    <div class="grid grid-3">
      <div class="card vstack"><div class="subtle">Active sites</div><div class="kpi">${STATE.sites.length}</div></div>
      <div class="card vstack"><div class="subtle">Docs due in 30 days</div><div class="kpi">—</div></div>
      <div class="card vstack"><div class="subtle">Non-compliant workers</div><div class="kpi">—</div></div>
    </div>

    <div class="section-title"><h3>Sites</h3><a class="btn-outline" href="#/sites">Vedi tutti</a></div>
    <div class="grid grid-2" id="sitesGrid"></div>
  `;
  qs('#sitesGrid').innerHTML = STATE.sites.map(s => siteCard(s)).join('');
  qs('#btnNewSite').onclick = openNewSiteDialog;
}

function renderSites(app){
  app.innerHTML = `
    <div class="section-title">
      <h2>Sites</h2>
      <button class="btn" id="btnNewSite">+ New Site</button>
    </div>
    <div class="grid grid-2" id="sitesGrid"></div>
  `;
  qs('#sitesGrid').innerHTML = STATE.sites.map(s => siteCard(s)).join('');
  qs('#btnNewSite').onclick = openNewSiteDialog;
}

function siteCard(s){
  const period = (s.dates?.start||'') && (s.dates?.end||'') ? `${s.dates.start} → ${s.dates.end}` : (s.dates?.start||'—');
  return `
  <div class="sitecard" onclick="location.hash='#/sites/${s.id}'">
    <div class="subtle">${s.id}</div>
    <div style="font-weight:700">${s.name||'—'}</div>
    <div class="subtle">${s.address||'—'}</div>
    <div>Client: <span class="subtle">${s.client||'—'}</span></div>
    <div class="subtle">Period: ${period||'—'}</div>
  </div>`;
}

function renderWorkers(app){
  app.innerHTML = `
    <div class="section-title"><h2>Workers</h2></div>
    <div class="card">
      <table class="table">
        <thead><tr><th>Nome</th><th>CF</th><th>Ruolo</th><th>Stato</th></tr></thead>
        <tbody>${STATE.workers.map(w=>`
          <tr>
            <td>${w.name}</td>
            <td class="subtle">${w.cf}</td>
            <td>${w.role||'Operaio'}</td>
            <td>${(w.docs?.visita_medica||w.docs?.corso_generale||w.docs?.corso_specifica_fs)?'<span class="pill-ok">Qualificato</span>':'<span class="pill-bad">Non qualificato</span>'}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderPOS(app){
  app.innerHTML = `
    <div class="section-title"><h2>POS</h2></div>
    <div class="card">Apri un cantiere e genera il POS dalla tab “POS”.</div>
  `;
}

function renderOCR(app){
  app.innerHTML = `
    <div class="section-title"><h2>OCR</h2></div>
    <div class="card">Carica documenti dalla tab “Documents” del cantiere o dalla scheda lavoratore.</div>
  `;
}

async function renderSiteDetail(app, id){
  const site = STATE.sites.find(x=>x.id===id);
  if (!site){ app.innerHTML = `<div class="card">Cantiere non trovato.</div>`; return; }

  const assigned = await fetch(`${API}/sites/${id}/workers`).then(r=>r.json()).catch(()=>[]);

  app.innerHTML = `
    <div class="vstack" style="gap:8px;margin-bottom:8px">
      <div class="hstack" style="justify-content:space-between">
        <h2>${site.name}</h2>
        <a class="btn-outline" href="#/sites">← Indietro</a>
      </div>
      <div class="subtle">${site.address||'—'}</div>
      <div>Client: <span class="subtle">${site.client||'—'}</span></div>
      <div class="subtle">Periodo: ${(site.dates?.start||'—')} → ${(site.dates?.end||'—')}</div>
    </div>

    <div class="card">
      <div class="section-title"><h3>Workers</h3></div>
      <table class="table" id="tblWorkers">
        <thead><tr><th>Lavoratore</th><th>Tipo</th><th>Stato</th><th style="width:1%"></th></tr></thead>
        <tbody>
          ${assigned.map(w=>rowWorker(w,site.id)).join('')}
        </tbody>
      </table>
      <hr>
      <div class="hstack">
        <select id="selAddWorker">
          <option value="">Seleziona lavoratore…</option>
          ${STATE.workers.map(w=>`<option value="${w.id}">${w.name} — ${w.cf}</option>`).join('')}
        </select>
        <button class="btn" id="btnAddWorker">Aggiungi</button>
      </div>
      <div class="help">L’assegnazione usa le nuove API: POST/DELETE <code>/api/sites/:id/workers</code>.</div>
    </div>

    <div class="grid grid-2" style="margin-top:14px">
      <div class="card">
        <div class="section-title">
          <h3>POS</h3>
          <button class="btn" id="btnGenPos">Genera POS (PDF)</button>
        </div>
        <div id="posPreview" class="subtle">Seleziona i lavoratori da “Workers” (sopra) e genera il POS.</div>
      </div>
      <div class="card">
        <div class="section-title"><h3>Documents</h3></div>
        <div class="alert">Upload/OCR dalla scheda lavoratore (roadmap: estrazione scadenze automatica).</div>
      </div>
    </div>
  `;

  qs('#btnAddWorker').onclick = async ()=>{
    const wid = qs('#selAddWorker').value;
    if(!wid) return;
    const resp = await fetch(`${API}/sites/${site.id}/workers`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ worker_id: wid })
    });
    if(!resp.ok){
      alert('Impossibile assegnare (POST /api/sites/:id/workers)'); return;
    }
    routerToSameSite(site.id);
  };

  qs('#btnGenPos').onclick = async ()=>{
    const res = await fetch(`${API}/sites/${site.id}/workers`);
    const workers = res.ok ? await res.json() : [];
    const out = await fetch(`${API}/pos`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ site, workers })
    }).then(r=>r.json()).catch(()=>null);
    if(out?.ok && out.url){ window.open(out.url, '_blank'); }
  };
}

function rowWorker(w, siteId){
  const status = (w.docs?.visita_medica || w.docs?.corso_generale || w.docs?.corso_specifica_fs) ? 'Qualificato' : 'Non qualificato';
  return `
  <tr>
    <td>${w.name}<div class="subtle">${w.cf}</div></td>
    <td>${w.role || 'Dipendente'}</td>
    <td>${status}</td>
    <td><button class="btn-outline" onclick="removeWorker('${siteId}','${w.id}')">Rimuovi</button></td>
  </tr>`;
}
async function removeWorker(siteId, workerId){
  const res = await fetch(`${API}/sites/${siteId}/workers/${workerId}`, { method:'DELETE' });
  if(!res.ok){ alert('Impossibile rimuovere'); return; }
  routerToSameSite(siteId);
}
function routerToSameSite(id){ location.hash = `#/sites/${id}`; setTimeout(router, 0); }

/* --------- MODAL NEW SITE ---------- */
function openNewSiteDialog(){
  const back = qs('#siteModal');
  back.classList.add('show');

  const get = id => qs(id);
  get('#m_site_name').value = '';
  get('#m_site_address').value = '';
  get('#m_site_start').value = '';
  get('#m_site_end').value = '';
  get('#m_site_client').value = '';
  get('#m_site_cse_email').value = '';

  const close = ()=> back.classList.remove('show');
  qs('#m_cancel').onclick = close;

  qs('#m_create').onclick = async ()=>{
    const name    = get('#m_site_name').value.trim();
    const address = get('#m_site_address').value.trim();
    const start   = get('#m_site_start').value || '';
    const end     = get('#m_site_end').value   || '';
    const client  = get('#m_site_client').value.trim();
    const cseMail = get('#m_site_cse_email').value.trim();

    if(!name){ alert('Inserisci il nome del cantiere'); return; }
    if(!address){ alert('Inserisci l’indirizzo'); return; }
    if(!start){ alert('Inserisci la data di inizio'); return; }

    const payload = {
      name, address, client,
      dates: { start, end },
      cse: { name:null, email: cseMail || null },
      roles: [] // il backend assegna owner al creatore
    };

    const res = await fetch(`${API}/sites`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const site = await res.json().catch(()=>null);
    if(!res.ok || !site?.id){
      alert(site?.errors?.join('\n') || 'Errore creazione'); return;
    }
    STATE.sites = await fetch(`${API}/sites`).then(r=>r.json()).catch(()=>STATE.sites);
    close();
    location.hash = `#/sites/${site.id}`;
  };

  back.addEventListener('click', (ev)=>{ if(ev.target===back) back.classList.remove('show'); }, { once:true });
}

/* ------------ BOOT ------------- */
(async function boot(){
  setActive();
  await router();
})();
</script>
</body>
</html>
