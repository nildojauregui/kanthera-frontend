<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kanthera MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0B1220] text-slate-100">
<header class="sticky top-0 bg-[#0B1220]/80 backdrop-blur border-b border-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-blue-500 grid place-items-center font-bold">K</div>
      <div class="font-semibold leading-tight">
        KANTHERA
        <div class="text-xs text-slate-400">Tu costruisci. Noi semplifichiamo.</div>
      </div>
    </div>
    <nav class="text-sm text-slate-300 flex gap-4">
      <a href="#dashboard" class="hover:text-white">Dashboard</a>
      <a href="#sites" class="hover:text-white">Sites</a>
      <a href="#workers" class="hover:text-white">Workers</a>
      <a href="#pos" class="hover:text-white">POS</a>
      <a href="#upload" class="hover:text-white">OCR Upload</a>
    </nav>
  </div>
</header>
<main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
  <section id="dashboard">
    <h1 class="text-2xl font-semibold mb-3">Dashboard</h1>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-[#0E1628] p-4 rounded-xl border border-slate-800"><div class="text-sm text-slate-400">Active sites</div><div id="k_sites" class="text-3xl font-semibold mt-1">—</div></div>
      <div class="bg-[#0E1628] p-4 rounded-xl border border-slate-800"><div class="text-sm text-slate-400">Docs due in 30 days</div><div id="k_due" class="text-3xl font-semibold mt-1">—</div></div>
      <div class="bg-[#0E1628] p-4 rounded-xl border border-slate-800"><div class="text-sm text-slate-400">Non-compliant workers</div><div id="k_noncomp" class="text-3xl font-semibold mt-1">—</div></div>
    </div>
  </section>

  <section id="sites">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">Sites</h2>
      <button id="btnNewSite" class="px-3 py-2 rounded bg-blue-500 text-white text-sm">+ New Site</button>
    </div>
    <div id="sites_grid" class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>

  <section id="workers">
    <h2 class="text-xl font-semibold">Workers</h2>
    <div id="workers_grid" class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>

  <section id="pos">
    <h2 class="text-xl font-semibold">POS Composer</h2>
    <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 bg-[#0E1628] border border-slate-800 p-4 rounded-xl">
        <div class="text-sm mb-3">Choose site:</div>
        <select id="siteSelect" class="w-full bg-[#0B1220] border border-slate-700 rounded p-2 text-sm"></select>
        <hr class="my-4 border-slate-800">
        <div class="font-medium mb-2">Preview</div>
        <pre id="posPreview" class="text-xs bg-[#0B1220] border border-slate-800 rounded p-3 whitespace-pre-wrap"></pre>
      </div>
      <div class="bg-[#0E1628] border border-slate-800 p-4 rounded-xl">
        <div class="font-medium">Actions</div>
        <button id="btnGen" class="mt-3 w-full px-3 py-2 rounded bg-blue-500 text-white text-sm">Generate POS (PDF)</button>
        <div id="msg" class="text-xs text-slate-400 mt-2"></div>
      </div>
    </div>
  </section>

  <section id="upload">
    <h2 class="text-xl font-semibold">OCR Upload</h2>
    <div class="bg-[#0E1628] border border-slate-800 p-4 rounded-xl max-w-xl">
      <input id="fileInput" type="file" class="w-full text-sm">
      <button id="btnUpload" class="mt-3 px-3 py-2 rounded bg-blue-500 text-white text-sm">Upload & OCR</button>
      <div id="uploadMsg" class="text-xs text-slate-400 mt-2"></div>
      <pre id="ocrOut" class="text-xs bg-[#0B1220] border border-slate-800 rounded p-3 whitespace-pre-wrap mt-3"></pre>
    </div>
  </section>
</main>
<footer class="border-t border-slate-800 py-6 mt-10 text-center text-xs text-slate-500">
  © Kanthera — Tu costruisci. Noi semplifichiamo.
</footer>

<script>
const API = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://localhost:3001/api' : (location.origin+'/api');

const fmtDays = (dstr)=>{const t=new Date(), d=new Date(dstr); return Math.floor((d - t)/(1000*60*60*24));}
function badge(dateStr){
  if(!dateStr) return '<span class=\"px-2 py-0.5 rounded-full text-xs bg-slate-700 text-slate-200\">N/D</span>';
  const d=fmtDays(dateStr);
  if(d<0) return '<span class=\"px-2 py-0.5 rounded-full text-xs bg-red-600 text-white\">Expired</span>';
  if(d<=14) return '<span class=\"px-2 py-0.5 rounded-full text-xs bg-amber-500 text-black\">≤14d</span>';
  if(d<=30) return '<span class=\"px-2 py-0.5 rounded-full text-xs bg-yellow-500 text-black\">≤30d</span>';
  return '<span class=\"px-2 py-0.5 rounded-full text-xs bg-emerald-600 text-white\">OK</span>';
}
async function loadAll(){
  const [sites, workers] = await Promise.all([
    fetch(API+'/sites').then(r=>r.json()),
    fetch(API+'/workers').then(r=>r.json())
  ]);

// Dashboard
document.getElementById('k_sites').textContent = sites.length;
let due=0, non=0;
workers.forEach(w=>['corso','visita'].forEach(k=>{const dt=w.docs[k]; if(dt&&fmtDays(dt)<=30) due++; if(dt&&fmtDays(dt)<=0) non++;}));
document.getElementById('k_due').textContent = due;
document.getElementById('k_noncomp').textContent = non;

// Sites
document.getElementById('sites_grid').innerHTML = sites.map(s=>`
  <div class='border border-slate-800 rounded-xl p-4 bg-[#0E1628]'>
    <div class='text-xs text-slate-400'>${s.id}</div>
    <div class='font-semibold'>${s.name}</div>
    <div class='text-sm text-slate-300'>${s.address}</div>
    <div class='mt-1 text-sm'>Client: <span class='font-medium'>${s.client}</span></div>
    <div class='mt-2 text-sm'>Period: ${s.dates.start} → ${s.dates.end}</div>
  </div>`).join('');

// Workers
document.getElementById('workers_grid').innerHTML = workers.map(w=>`
  <div class='bg-[#0E1628] border border-slate-800 p-4 rounded-xl'>
    <div class='text-xs text-slate-400'>${w.id} • ${w.role}</div>
    <div class='font-semibold'>${w.name}</div>
    <div class='text-sm text-slate-300'>CF: ${w.cf}</div>
    <div class='mt-2 text-sm flex gap-3 items-center'>
      <span>Course:</span> ${badge(w.docs.corso)}
      <span>Checkup:</span> ${badge(w.docs.visita)}
    </div>
  </div>`).join('');

// POS
const siteSel = document.getElementById('siteSelect');
siteSel.innerHTML = sites.map(s=>`<option value='${s.id}'>${s.id} — ${s.name}</option>`).join('');
siteSel.onchange = ()=>updatePreview();
updatePreview();
function updatePreview(){
  const sid = siteSel.value || sites[0].id;
  const s = sites.find(x=>x.id===sid) || sites[0];
  const ws = workers.filter(w=>s.workers.includes(w.id));
  const lines = [];
  lines.push('POS – Piano Operativo di Sicurezza');
  lines.push('Site: '+s.name+' — '+s.address);
  lines.push('Client: '+s.client+' — '+s.client_cf_piva);
  lines.push('CSE: '+s.cse.name+' — '+s.cse.email);
  lines.push('Period: '+s.dates.start+' → '+s.dates.end);
  lines.push('');
  lines.push('Workers:');
  ws.forEach(w=>lines.push(' - '+w.name+' ('+w.role+') • Course: '+(w.docs.corso||'N/A')+' • Checkup: '+(w.docs.visita||'N/A')));
  document.getElementById('posPreview').textContent = lines.join('\n');
}
document.getElementById('btnGen').onclick = async ()=>{
  const sid = siteSel.value || sites[0].id;
  const s = sites.find(x=>x.id===sid) || sites[0];
  const ws = workers.filter(w=>s.workers.includes(w.id));
  const payload = { site:s, workers:ws, vars:{ activities:'—', risks:'—', measures:'—' } };
  const r = await fetch(API+'/pos',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).then(r=>r.json());
  document.getElementById('msg').textContent = r.ok ? ('PDF generated: '+r.file) : 'Error generating PDF';
};

// OCR upload
document.getElementById('btnUpload').onclick = async () => {
  const f = document.getElementById('fileInput').files[0];
  if(!f){ document.getElementById('uploadMsg').textContent = 'Please choose a file'; return; }
  const fd = new FormData(); fd.append('file', f);
  document.getElementById('uploadMsg').textContent = 'Uploading…';
  const r = await fetch(API+'/upload', { method:'POST', body:fd }).then(r=>r.json());
  document.getElementById('uploadMsg').textContent = r.ok ? ('Uploaded: '+r.file) : 'Error';
  document.getElementById('ocrOut').textContent = r.ocr || '';
};
}
loadAll();
}
</script>
</body>
</html>
