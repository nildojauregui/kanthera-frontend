<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KANTHERA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0B1220;--card:#0f172a;--mut:#94a3b8;--line:#1f2937;--fg:#e5e7eb;--brand:#3b82f6;--ok:#22c55e;--warn:#f59e0b}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 Inter,system-ui}
.container{max-width:1180px;margin:0 auto;padding:20px}
.header{display:flex;gap:14px;align-items:center;padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);z-index:10}
.logo{display:flex;gap:10px;align-items:center;font-weight:700}
.logo-badge{width:28px;height:28px;border-radius:8px;background:var(--brand);display:grid;place-content:center;font-weight:800}
.nav{margin-left:auto;display:flex;gap:12px}
.nav a{padding:.45rem .7rem;border-radius:8px;color:#cbd5e1;text-decoration:none}
.nav a.active{background:rgba(148,163,184,.14)}
.btn{background:var(--brand);border:none;border-radius:8px;color:#fff;padding:.55rem .9rem;cursor:pointer;font-weight:600}
.btn-outline{border:1px solid var(--line);background:transparent;border-radius:8px;color:#cbd5e1;padding:.55rem .9rem;cursor:pointer}
.btn-danger{background:#ef4444;border:none;border-radius:8px;color:#fff;padding:.42rem .7rem;cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
.grid{display:grid;gap:14px}.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 10px}
.kpi{font-size:24px;font-weight:700}.subtle{color:var(--mut)}
/* site card */
.sitecard{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px;cursor:pointer}
.sitecard:hover{border-color:#2a3b5a}
/* table */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
.table thead th{color:#e2e8f0;background:#0e2f41;font-weight:700}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.56);display:none;align-items:center;justify-content:center;z-index:60}
.modal-backdrop.show{display:flex}
.modal{width:min(920px,96vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
.modal h3{margin:0 0 12px}
.modal .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}.modal .col-span-2{grid-column:1/-1}
.modal footer{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
input,select,textarea{width:100%;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:.6rem .7rem;border-radius:10px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:.16rem .52rem;color:var(--mut);font-size:12px}
.pill-ok{color:var(--ok);font-weight:700}.pill-bad{color:#ef4444;font-weight:700}
.center{display:grid;place-items:center}
</style>
</head>
<body>
<header class="header">
  <div class="logo"><div class="logo-badge">K</div>KANTHERA <span class="subtle">Tu costruisci. Noi semplifichiamo.</span></div>
  <nav class="nav">
    <a href="#/dashboard" id="lnkDash">Dashboard</a>
    <a href="#/sites" id="lnkSites">Sites</a>
    <a href="#/workers" id="lnkWorkers">Workers</a>
    <a href="#/pos" id="lnkPos">POS</a>
    <a href="#/ocr" id="lnkOcr">OCR</a>
  </nav>
</header>

<main class="container" id="app"></main>

<!-- Modal: Nuovo/Modifica Cantiere -->
<div id="siteModal" class="modal-backdrop">
  <div class="modal">
    <h3 id="siteModalTitle">Nuovo cantiere</h3>
    <div class="grid">
      <div class="col-span-2"><label>Nome</label><input id="m_site_name"></div>
      <div class="col-span-2"><label>Indirizzo</label><input id="m_site_address"></div>
      <div><label>Data inizio</label><input id="m_site_start" type="date"></div>
      <div><label>Data fine (opz.)</label><input id="m_site_end" type="date"></div>
      <div><label>Cliente (opz.)</label><input id="m_site_client"></div>
      <div><label>Email CSE (opz.)</label><input id="m_site_cse_email" type="email"></div>
    </div>
    <footer>
      <button id="m_site_cancel" class="btn-outline">Annulla</button>
      <button id="m_site_save" class="btn">Crea</button>
    </footer>
  </div>
</div>

<!-- Modal: Nuovo/Modifica Lavoratore -->
<div id="workerModal" class="modal-backdrop">
  <div class="modal">
    <h3 id="workerModalTitle">Nuovo lavoratore</h3>
    <div class="grid">
      <div><label>Nome e cognome</label><input id="w_name" placeholder="Mario Rossi"></div>
      <div><label>Codice Fiscale</label><input id="w_cf" placeholder="RSSMRA..."></div>
      <div><label>Ruolo</label>
        <select id="w_role">
          <option>Dipendente</option><option>Operaio</option><option>Preposto</option><option>Tecnico</option>
        </select>
      </div>
      <div class="col-span-2"><span class="subtle">Documenti (flag veloci):</span></div>
      <div><label><input type="checkbox" id="w_doc_vm"> Visita medica</label></div>
      <div><label><input type="checkbox" id="w_doc_gen"> Formazione generale</label></div>
      <div><label><input type="checkbox" id="w_doc_spec"> Formazione specifica FS</label></div>
      <div><label><input type="checkbox" id="w_doc_ant"> Addetto Antincendio</label></div>
      <div><label><input type="checkbox" id="w_doc_ps"> Addetto Primo Soccorso</label></div>
      <div><label><input type="checkbox" id="w_doc_pre"> Preposto</label></div>
      <div><label><input type="checkbox" id="w_doc_dpi"> Consegna DPI</label></div>
    </div>
    <footer>
      <button id="w_cancel" class="btn-outline">Annulla</button>
      <button id="w_save" class="btn">Salva</button>
    </footer>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = (window.API_BASE || 'https://kanthera-backend.onrender.com/api'); // <— cambia se serve
const qs=(s,el=document)=>el.querySelector(s);const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const STATE={sites:[],workers:[],company:{}, editingWorker:null, editingSite:null};

/* ===== NAV / ROUTER ===== */
function setActive(){ const h=location.hash||'#/dashboard'; qsa('.nav a').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===h)); }
window.addEventListener('hashchange',()=>{setActive();router();});

async function router(){
  const app=qs('#app'), h=location.hash||'#/dashboard';
  if(!STATE.sites.length)   STATE.sites   = await fetch(`${API}/sites`).then(r=>r.json()).catch(()=>[]);
  if(!STATE.workers.length) STATE.workers = await fetch(`${API}/workers`).then(r=>r.json()).catch(()=>[]);
  if(!STATE.company.name)   STATE.company = await fetch(`${API}/company`).then(r=>r.json()).catch(()=>({}));

  if(h.startsWith('#/sites/')){ renderSiteDetail(app,h.split('/')[2]); }
  else if(h==='#/sites'){ renderSites(app); }
  else if(h==='#/workers'){ renderWorkers(app); }
  else if(h==='#/pos'){ renderPOS(app); }
  else if(h==='#/ocr'){ renderOCR(app); }
  else { renderDashboard(app); }
}

/* ===== DASHBOARD ===== */
function renderDashboard(app){
  app.innerHTML=`
    <div class="section-title"><h2>Dashboard</h2><button class="btn" id="btnNewSite">+ New Site</button></div>
    <div class="grid grid-3">
      <div class="card"><div class="subtle">Active sites</div><div class="kpi">${STATE.sites.length}</div></div>
      <div class="card"><div class="subtle">Docs due in 30 days</div><div class="kpi">—</div></div>
      <div class="card"><div class="subtle">Non-compliant workers</div><div class="kpi">—</div></div>
    </div>
    <div class="section-title"><h3>Sites</h3><a class="btn-outline" href="#/sites">Vedi tutti</a></div>
    <div class="grid grid-2" id="sitesGrid"></div>
  `;
  qs('#sitesGrid').innerHTML=STATE.sites.map(siteCard).join('');
  qs('#btnNewSite').onclick=()=>openSiteModal();
}
function siteCard(s){
  const period=(s.dates?.start||'')&&(s.dates?.end||'')?`${s.dates.start} → ${s.dates.end}`:(s.dates?.start||'—');
  return `<div class="sitecard" onclick="location.hash='#/sites/${s.id}'">
    <div class="subtle">${s.id}</div>
    <div style="font-weight:700">${s.name||'—'}</div>
    <div class="subtle">${s.address||'—'}</div>
    <div>Client: <span class="subtle">${s.client||'—'}</span></div>
    <div class="subtle">Period: ${period||'—'}</div>
  </div>`;
}

/* ===== SITES LIST ===== */
function renderSites(app){
  app.innerHTML=`
    <div class="section-title"><h2>Sites</h2><button class="btn" id="btnNewSite">+ New Site</button></div>
    <div class="grid grid-2" id="sitesGrid"></div>`;
  qs('#sitesGrid').innerHTML=STATE.sites.map(siteCard).join('');
  qs('#btnNewSite').onclick=()=>openSiteModal();
}

/* ===== SITE DETAIL ===== */
function statusFromDocs(d){
  const ok = !!(d?.visita_medica || d?.corso_generale || d?.corso_specifica_fs);
  return ok ? '<span class="pill-ok">Qualificato</span>' : '<span class="pill-bad">Non qualificato</span>';
}
function progressFromDocs(d){
  const needed = ['visita_medica','corso_generale','corso_specifica_fs','dpi_consegna'];
  const done = needed.every(k=>!!d?.[k]);
  return done ? '<span style="color:var(--ok)">Documentazione completata</span>' :
                '<span style="color:var(--warn)">Documentazione da completare</span>';
}
function tick(v){ return v ? '✓' : '—'; }

async function renderSiteDetail(app,id){
  const site=STATE.sites.find(x=>x.id===id);
  if(!site){app.innerHTML=`<div class="card">Cantiere non trovato</div>`;return;}
  const assigned=await fetch(`${API}/sites/${id}/workers`).then(r=>r.json()).catch(()=>[]);

  app.innerHTML=`
    <div style="margin-bottom:10px">
      <div class="section-title"><h2>${site.name}</h2><a class="btn-outline" href="#/sites">← Indietro</a></div>
      <div class="subtle">${site.address||'—'}</div>
      <div>Client: <span class="subtle">${site.client||'—'}</span></div>
      <div class="subtle">Periodo: ${(site.dates?.start||'—')} → ${(site.dates?.end||'—')}</div>
    </div>

    <div class="card">
      <div class="section-title"><h3>Workers</h3></div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Lavoratore</th><th>Tipo</th><th>Stato</th>
              <th>Preposto</th><th>Antincendio</th><th>Primo Soccorso</th><th>Avanzamento</th><th></th>
            </tr>
          </thead>
          <tbody id="siteWorkersBody">
            ${assigned.map(w=>`
              <tr>
                <td>${w.name}<div class="subtle">${w.cf}</div></td>
                <td>${w.role||'Dipendente'}</td>
                <td>${statusFromDocs(w.docs||{})}</td>
                <td class="center">${tick(w.docs?.preposto)}</td>
                <td class="center">${tick(w.docs?.antincendio)}</td>
                <td class="center">${tick(w.docs?.primo_soccorso)}</td>
                <td>${progressFromDocs(w.docs||{})}</td>
                <td><button class="btn-outline" onclick="removeWorker('${site.id}','${w.id}')">Rimuovi</button></td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <hr>
      <div style="display:flex;gap:10px;align-items:center">
        <select id="selAddWorker">
          <option value="">Seleziona lavoratore…</option>
          ${STATE.workers.map(w=>`<option value="${w.id}">${w.name} — ${w.cf}</option>`).join('')}
        </select>
        <button class="btn" id="btnAddWorker">Aggiungi</button>
        <span class="subtle">/ Per creare un nuovo lavoratore vai alla sezione <a href="#/workers">Workers</a>.</span>
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:14px">
      <div class="card">
        <div class="section-title"><h3>POS</h3><button class="btn" id="btnGenPos">Genera POS (PDF)</button></div>
        <div class="subtle">Il POS includerà i lavoratori assegnati sopra.</div>
      </div>
      <div class="card">
        <div class="section-title"><h3>Documents</h3></div>
        <div class="subtle">Upload / OCR dalla scheda lavoratore (roadmap estrazione scadenze automatica).</div>
      </div>
    </div>
  `;

  qs('#btnAddWorker').onclick = async ()=>{
    const wid=qs('#selAddWorker').value; if(!wid) return;
    const r=await fetch(`${API}/sites/${site.id}/workers`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({worker_id:wid})});
    if(!r.ok){ alert('Impossibile assegnare (POST /api/sites/:id/workers)'); return; }
    location.hash=`#/sites/${site.id}`; setTimeout(router,0);
  };
  qs('#btnGenPos').onclick = async ()=>{
    const res = await fetch(`${API}/sites/${site.id}/workers`);
    const workers = res.ok? await res.json():[];
    const out = await fetch(`${API}/pos`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({site,workers})}).then(r=>r.json()).catch(()=>null);
    if(out?.ok && out.url) window.open(out.url,'_blank');
  };
}
async function removeWorker(siteId,workerId){
  const r=await fetch(`${API}/sites/${siteId}/workers/${workerId}`,{method:'DELETE'});
  if(!r.ok){ alert('Impossibile rimuovere'); return; }
  location.hash=`#/sites/${siteId}`; setTimeout(router,0);
}

/* ===== WORKERS ===== */
function renderWorkers(app){
  app.innerHTML=`
    <div class="section-title"><h2>Workers</h2><button class="btn" id="btnNewWorker">+ Nuovo lavoratore</button></div>
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Lavoratore</th><th>Tipo</th><th>Stato</th>
            <th>Preposto</th><th>Antincendio</th><th>Primo Soccorso</th><th>Avanzamento</th><th></th>
          </tr>
        </thead>
        <tbody id="workersBody">
          ${STATE.workers.map(w=>workerRow(w)).join('')}
        </tbody>
      </table>
    </div>
  `;
  qs('#btnNewWorker').onclick=()=>openWorkerModal();
}
function workerRow(w){
  return `<tr>
    <td>${w.name}<div class="subtle">${w.cf}</div></td>
    <td>${w.role||'Dipendente'}</td>
    <td>${statusFromDocs(w.docs||{})}</td>
    <td class="center">${tick(w.docs?.preposto)}</td>
    <td class="center">${tick(w.docs?.antincendio)}</td>
    <td class="center">${tick(w.docs?.primo_soccorso)}</td>
    <td>${progressFromDocs(w.docs||{})}</td>
    <td class="hstack">
      <button class="btn-outline" onclick='openWorkerModal(${JSON.stringify(w).replace(/"/g,"&quot;")})'>Modifica</button>
    </td>
  </tr>`;
}

/* ===== POS / OCR placeholder ===== */
function renderPOS(app){ app.innerHTML=`<div class="section-title"><h2>POS</h2></div><div class="card">Apri un cantiere e genera da lì.</div>`; }
function renderOCR(app){ app.innerHTML=`<div class="section-title"><h2>OCR</h2></div><div class="card">Carica i documenti dalla scheda lavoratore.</div>`; }

/* ===== MODAL: SITE ===== */
function openSiteModal(site=null){
  STATE.editingSite = site;
  qs('#siteModalTitle').textContent = site?'Modifica cantiere':'Nuovo cantiere';
  const back=qs('#siteModal'); back.classList.add('show');
  qs('#m_site_name').value=site?.name||'';
  qs('#m_site_address').value=site?.address||'';
  qs('#m_site_start').value=site?.dates?.start||'';
  qs('#m_site_end').value=site?.dates?.end||'';
  qs('#m_site_client').value=site?.client||'';
  qs('#m_site_cse_email').value=site?.cse?.email||'';
  qs('#m_site_cancel').onclick=()=>back.classList.remove('show');
  qs('#m_site_save').textContent = site?'Salva':'Crea';
  qs('#m_site_save').onclick=async ()=>{
    const name=qs('#m_site_name').value.trim();
    const address=qs('#m_site_address').value.trim();
    const start=qs('#m_site_start').value||''; if(!name||!address||!start){ alert('Compila nome, indirizzo e data inizio'); return; }
    const payload={name,address,client:qs('#m_site_client').value.trim(),dates:{start,end:qs('#m_site_end').value||''},cse:{name:null,email:qs('#m_site_cse_email').value||null}};
    const r=await fetch(`${API}/sites`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ const j=await r.json().catch(()=>null); alert(j?.errors?.join('\n')||'Errore'); return; }
    STATE.sites = await fetch(`${API}/sites`).then(x=>x.json());
    back.classList.remove('show');
    location.hash = `#/sites/${(await r.json()).id}`;
  };
  back.addEventListener('click',(e)=>{if(e.target===back) back.classList.remove('show')},{once:true});
}

/* ===== MODAL: WORKER (NEW/EDIT) ===== */
function openWorkerModal(worker=null){
  STATE.editingWorker = worker;
  const back=qs('#workerModal'); back.classList.add('show');
  qs('#workerModalTitle').textContent = worker?'Modifica lavoratore':'Nuovo lavoratore';
  // bind values
  qs('#w_name').value = worker?.name||'';
  qs('#w_cf').value   = worker?.cf||'';
  qs('#w_role').value = worker?.role||'Dipendente';
  const d = worker?.docs||{};
  qs('#w_doc_vm').checked   = !!d.visita_medica;
  qs('#w_doc_gen').checked  = !!d.corso_generale;
  qs('#w_doc_spec').checked = !!d.corso_specifica_fs;
  qs('#w_doc_ant').checked  = !!d.antincendio;
  qs('#w_doc_ps').checked   = !!d.primo_soccorso;
  qs('#w_doc_pre').checked  = !!d.preposto;
  qs('#w_doc_dpi').checked  = !!d.dpi_consegna;

  qs('#w_cancel').onclick=()=>back.classList.remove('show');
  qs('#w_save').onclick=async ()=>{
    const name=qs('#w_name').value.trim(), cf=qs('#w_cf').value.trim(), role=qs('#w_role').value;
    if(!name||!cf){ alert('Nome e CF obbligatori'); return; }
    const docs={
      visita_medica: qs('#w_doc_vm').checked,
      corso_generale: qs('#w_doc_gen').checked,
      corso_specifica_fs: qs('#w_doc_spec').checked,
      antincendio: qs('#w_doc_ant').checked,
      primo_soccorso: qs('#w_doc_ps').checked,
      preposto: qs('#w_doc_pre').checked,
      dpi_consegna: qs('#w_doc_dpi').checked
    };
    if(worker){ // PATCH
      const r=await fetch(`${API}/workers/${worker.id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,cf,role,docs})});
      if(!r.ok){ alert('Errore salvataggio'); return; }
    }else{ // POST
      const r=await fetch(`${API}/workers`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,cf,role,docs})});
      if(!r.ok){ alert('Errore creazione'); return; }
    }
    STATE.workers = await fetch(`${API}/workers`).then(x=>x.json()).catch(()=>STATE.workers);
    back.classList.remove('show');
    router(); // refresh current view
  };
  back.addEventListener('click',(e)=>{if(e.target===back) back.classList.remove('show')},{once:true});
}

/* ===== BOOT ===== */
(async function boot(){ setActive(); await router(); })();
</script>
</body>
</html>
