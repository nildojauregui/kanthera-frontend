<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KANTHERA — V2.1</title>
<style>
  :root{
    --bg:#0a0f1a; --panel:#0e1625; --panel-2:#142034; --panel-3:#0b1220;
    --text:#e5e9f3; --muted:#99a3b3; --border:#1f2a3e; --brand:#3b82f6;
    --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  a{color:inherit; text-decoration:none}
  .app{max-width:1200px; margin:0 auto; padding:18px}
  .nav{
    display:flex; align-items:center; gap:18px; margin-bottom:18px
  }
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:28px; height:28px; border-radius:8px; background:#1b2640; display:grid; place-items:center; font-weight:700}
  .nav .tabs{margin-left:auto; display:flex; gap:8px}
  .nav .tab{
    padding:8px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--panel-3); color:#cbd5e1;
  }
  .nav .tab.active{background:var(--panel-2); color:#fff}
  h1,h2{margin:0 0 10px 0}
  .muted{color:var(--muted)}
  .badge{padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:var(--panel-3)}
  .chip{padding:3px 8px; border-radius:999px; background:#182238; border:1px solid var(--border)}
  .chip.green{background:#0e1f18; border-color:#123424; color:#a7f3d0}
  .chip.red{background:#2c1212; border-color:#3b1818; color:#fecaca}
  .chip.amber{background:#2b2214; border-color:#3e3016; color:#fde68a}

  .row{display:flex; align-items:center; gap:10px}
  .grow{flex:1}
  .grid{display:grid; gap:12px}
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
  }
  .section-title{display:flex; align-items:center; justify-content:space-between; margin:8px 0}
  .btn{
    background:var(--brand); color:#fff; border:0; border-radius:10px; padding:9px 12px; cursor:pointer;
  }
  .btn.secondary{background:#23324f}
  .btn.ghost{background:#0b1220; border:1px solid var(--border); color:#e5ecff}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  .input, select, input[type="date"], input[type="text"], input[type="email"]{
    width:100%; background:#0b1220; border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:#e6eefc
  }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  .field{display:block}
  .hidden{display:none !important}

  .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .kpi .card{min-height:86px}
  .big{font-size:28px; font-weight:700}

  .cards{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .cards .card:hover{outline:1px solid #263451; cursor:pointer}

  table{width:100%; border-collapse:separate; border-spacing:0 8px}
  thead th{font-weight:600; color:#b9c6dc; text-align:left; padding:6px 10px}
  tbody tr{background:var(--panel); border:1px solid var(--border)}
  tbody td{padding:10px}
  tbody tr{border-radius:10px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  .table{margin-top:8px}

  /* Tabs dettaglio */
  #sd-tabs .tab{
    padding:8px 12px; border-radius:10px; border:1px solid var(--border);
    background:#0b1220; color:#cbd5e1; margin-right:8px
  }
  #sd-tabs .tab.active{ background:var(--panel-2); color:#fff }

  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:18px; padding:10px 14px; background:#11223c;
    border:1px solid var(--border); border-radius:10px; color:#d9e6ff; opacity:0; transform:translateY(8px);
    transition:.25s; pointer-events:none; z-index:9999
  }
  .toast.show{opacity:1; transform:translateY(0)}
  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(5,10,20,.6); z-index:999}
  .modal.show{display:grid}
  .modal .sheet{width:min(720px, 92vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px}
  .modal .sheet h3{margin:0 0 12px 0}
  .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
  .hr{height:1px; background:var(--border); margin:8px 0}
</style>
</head>
<body>
<div class="app">

  <!-- NAV -->
  <div class="nav">
    <div class="brand">
      <div class="logo">K</div>
      <div>
        <div style="font-weight:700">KANTHERA</div>
        <div class="muted" style="font-size:12px">Tu costruisci. Noi semplifichiamo.</div>
      </div>
    </div>
    <div class="tabs nav">
      <a href="#" class="tab active" data-view="dashboard">Dashboard</a>
      <a href="#" class="tab" data-view="sites">Sites</a>
      <a href="#" class="tab" data-view="workers">Workers</a>
      <a href="#" class="tab" data-view="pos">POS</a>
      <a href="#" class="tab" data-view="ocr">OCR</a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="view-dashboard">
    <h2>Dashboard</h2>
    <div class="kpi">
      <div class="card">
        <div class="muted">Active sites</div>
        <div class="big" id="kpi-sites">—</div>
      </div>
      <div class="card">
        <div class="muted">Docs due in 30 days</div>
        <div class="big" id="kpi-due">—</div>
      </div>
      <div class="card">
        <div class="muted">Non-compliant workers</div>
        <div class="big" id="kpi-noncompliant">—</div>
      </div>
    </div>

    <div class="section-title" style="margin-top:18px">
      <h3>Sites</h3>
      <div class="row">
        <button class="btn" id="btn-new-site">+ New Site</button>
        <a class="btn ghost" href="#" data-view="sites">Vedi tutti</a>
      </div>
    </div>
    <div class="cards" id="sites-grid"></div>
  </section>

  <!-- SITES -->
  <section id="view-sites" class="hidden">
    <div class="section-title">
      <h2>Sites</h2>
      <button class="btn" id="btn-new-site-2">+ New Site</button>
    </div>
    <div class="cards" id="sites-grid-2"></div>
  </section>

  <!-- SITE DETAIL -->
  <section id="view-site-detail" class="hidden">
    <div class="row" style="margin-bottom:10px">
      <button class="btn ghost" id="site-back">← Indietro</button>
      <h2 class="grow" id="sd-title">Titolo cantiere</h2>
      <span class="chip" id="sd-id">CNT-0000</span>
    </div>

    <div class="row" id="sd-tabs" style="margin-bottom:8px">
      <a href="#" class="tab active" data-tab="ovw">Overview</a>
      <a href="#" class="tab" data-tab="wrk">Workers</a>
      <a href="#" class="tab" data-tab="doc">Documenti</a>
      <a href="#" class="tab" data-tab="pos">POS</a>
      <a href="#" class="tab" data-tab="act">Activity</a>
    </div>

    <!-- Overview -->
    <div class="card sd-pane" data-pane="ovw">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <div><div class="muted">Cliente</div><div id="sd-client" style="font-weight:600"></div></div>
        <div><div class="muted">Indirizzo</div><div id="sd-address" style="font-weight:600"></div></div>
        <div><div class="muted">Periodo</div><div id="sd-range" style="font-weight:600"></div></div>
      </div>
    </div>

    <!-- Workers -->
    <div class="card sd-pane hidden" data-pane="wrk">
      <div class="row" style="margin-bottom:10px">
        <div class="field grow">
          <label>Aggiungi lavoratore</label>
          <div class="row">
            <select id="sd-add-select" class="grow"></select>
            <button class="btn" id="sd-add-btn">Aggiungi</button>
          </div>
        </div>
        <button class="btn secondary" id="sd-upload-btn">Carica doc</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Lavoratore</th><th>Tipo</th><th>Stato</th>
            <th>Preposto</th><th>Antincendio</th><th>Primo Soccorso</th>
            <th>Avanzamento</th><th>Azioni</th>
          </tr>
        </thead>
        <tbody id="sd-workers"></tbody>
      </table>
    </div>

    <!-- Documenti -->
    <div class="card sd-pane hidden" data-pane="doc">
      <div class="muted">Documenti cantiere (POS, approvazioni, verbali). Placeholder MVP.</div>
    </div>

    <!-- POS -->
    <div class="card sd-pane hidden" data-pane="pos">
      <div class="row" style="margin-bottom:10px">
        <div class="grow muted">Componi il POS usando i lavoratori assegnati</div>
        <button class="btn" id="sd-pos-generate">Genera PDF</button>
      </div>
      <pre id="sd-pos-preview" class="input" style="white-space:pre-wrap; height:140px"></pre>
      <div id="sd-pos-link" class="row hidden" style="margin-top:10px">
        <small class="badge">PDF pronto</small>
        <a class="btn ghost" id="sd-pos-url" target="_blank">Apri PDF</a>
      </div>
    </div>

    <!-- Activity -->
    <div class="card sd-pane hidden" data-pane="act">
      <div class="muted">Log attività del cantiere. Placeholder MVP.</div>
    </div>
  </section>

  <!-- WORKERS -->
  <section id="view-workers" class="hidden">
    <div class="section-title">
      <h2>Workers</h2>
      <button class="btn" id="btn-new-worker">+ Nuovo lavoratore</button>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Lavoratore</th><th>Tipo</th><th>Stato</th>
          <th>Preposto</th><th>Antincendio</th><th>Primo Soccorso</th>
          <th>Avanzamento</th><th>Azioni</th>
        </tr>
      </thead>
      <tbody id="workers-tbody"></tbody>
    </table>
  </section>

  <!-- POS quick -->
  <section id="view-pos" class="hidden">
    <div class="section-title">
      <h2>POS Composer</h2>
      <div class="row">
        <select id="pos-site" class="input"></select>
        <button class="btn" id="pos-generate">Genera POS (PDF)</button>
      </div>
    </div>
    <pre id="pos-preview" class="input" style="white-space:pre-wrap; height:220px"></pre>
    <div id="pos-link" class="row hidden" style="margin-top:10px">
      <small class="badge">PDF pronto</small>
      <a class="btn ghost" id="pos-url" target="_blank">Apri PDF</a>
    </div>
  </section>

  <!-- OCR -->
  <section id="view-ocr" class="hidden">
    <h2>OCR Upload</h2>
    <div class="card">
      <div class="row">
        <select id="ocr-worker" class="grow"></select>
        <input type="file" id="ocr-file" />
        <button class="btn" id="ocr-upload">Upload & OCR</button>
      </div>
      <div class="hr"></div>
      <pre id="ocr-out" class="input" style="white-space:pre-wrap; height:220px"></pre>
    </div>
  </section>

</div>

<!-- MODAL: New Site -->
<div class="modal" id="modal-site">
  <div class="sheet">
    <h3>Nuovo cantiere</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="field"><label>Nome</label><input id="ms-name" class="input" placeholder="Es. Sede Cliente Verdi – Piano 3"></div>
      <div></div>
      <div class="field"><label>Indirizzo</label><input id="ms-address" class="input" placeholder="Via Roma 12, Bologna"></div>
      <div class="field"><label>Cliente (opz.)</label><input id="ms-client" class="input" placeholder="Cliente Verdi Srl"></div>
      <div class="field"><label>Data inizio</label><input id="ms-start" type="date" class="input"></div>
      <div class="field"><label>Data fine (opz.)</label><input id="ms-end" type="date" class="input"></div>
      <div class="field"><label>Email CSE (opz.)</label><input id="ms-cse" type="email" class="input" placeholder="laura.bianchi@..."></div>
      <div></div>
    </div>
    <div class="actions">
      <button class="btn ghost" data-close="#modal-site">Annulla</button>
      <button class="btn" id="ms-create">Crea</button>
    </div>
  </div>
</div>

<!-- MODAL: New Worker -->
<div class="modal" id="modal-worker">
  <div class="sheet">
    <h3>Nuovo lavoratore</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="field"><label>Nome e Cognome</label><input id="mw-name" class="input" placeholder="Mario Rossi"></div>
      <div class="field"><label>CF</label><input id="mw-cf" class="input" placeholder="RSSMRA..."></div>
      <div class="field"><label>Ruolo</label><input id="mw-role" class="input" placeholder="Posatore, Manovale, ..."></div>
      <div></div>
    </div>
    <div class="actions">
      <button class="btn ghost" data-close="#modal-worker">Annulla</button>
      <button class="btn" id="mw-create">Crea</button>
    </div>
  </div>
</div>

<!-- MODAL: Upload doc (OCR) -->
<div class="modal" id="modal-upload">
  <div class="sheet">
    <h3>Carica documento</h3>
    <div class="row">
      <select id="mu-worker" class="grow"></select>
      <input type="file" id="mu-file">
      <button class="btn" id="mu-upload">Upload & OCR</button>
    </div>
    <div class="hr"></div>
    <pre id="mu-out" class="input" style="white-space:pre-wrap; height:220px"></pre>
    <div class="actions">
      <button class="btn ghost" data-close="#modal-upload">Chiudi</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================
   1) CONFIG
============================= */
// ↓↓↓ IMPOSTA QUI L'URL DEL BACKEND ↓↓↓
const API_BASE = 'https://kanthera-backend.onrender.com/api';
// const API_BASE = 'http://localhost:10000/api';

/* ============================
   2) STATE
============================= */
let SITES = [];
let WORKERS = [];
let SD_SITE = null;           // cantiere corrente (detail)
let SD_WORKER_IDS = [];       // assegnati al cantiere corrente

/* ============================
   3) HELPERS
============================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function toast(msg){
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}
function show(view){
  ['#view-dashboard','#view-sites','#view-workers','#view-pos','#view-ocr','#view-site-detail']
    .forEach(s=> $(s).classList.add('hidden'));
  $('#view-'+view).classList.remove('hidden');
  $$('.nav .tab').forEach(a=> a.classList.toggle('active', a.dataset.view===view));
}

function fmtRange(a,b){
  if(!a && !b) return '—';
  const s = a ? new Date(a).toISOString().slice(0,10) : '—';
  const e = b ? new Date(b).toISOString().slice(0,10) : '—';
  return `${s} → ${e}`;
}
function sumQual(w){
  // idoneità base: visita + generale + specifica + DPI → "Qualificato"
  const ok = (w.docs?.visita_medica && w.docs?.corso_generale && w.docs?.corso_specifica_fs && w.docs?.dpi_consegna);
  return ok ? 'Qualificato' : 'Non qualificato';
}
async function fetchJSON(url, opts={}){
  const r = await fetch(url, { ...opts, headers: { 'Content-Type':'application/json', ...(opts.headers||{}) }});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function form(obj){ return JSON.stringify(obj); }
function openModal(id){ $(id).classList.add('show'); }
function closeModal(id){ $(id).classList.remove('show'); }

/* ============================
   4) RENDER
============================= */
function siteCard(s){
  const period = fmtRange(s.dates?.start, s.dates?.end);
  return `
  <div class="card">
    <div class="muted" style="font-size:12px">${s.id}</div>
    <div style="font-weight:700; font-size:17px; margin:4px 0">${s.name}</div>
    <div class="muted">${s.address||'—'}</div>
    <div class="muted" style="margin-top:6px"><b>Client:</b> ${s.client||'—'}</div>
    <div class="muted">Period: ${period}</div>
  </div>`;
}
function renderSites(){
  const html = SITES.map(siteCard).join('');
  $('#sites-grid').innerHTML = html;
  $('#sites-grid-2').innerHTML = html;
  ['#sites-grid','#sites-grid-2'].forEach(id=>{
    $(id).querySelectorAll('.card').forEach((card, idx)=>{
      card.onclick = ()=> openSiteDetail(SITES[idx].id);
    });
  });
  // POS quick select
  $('#pos-site').innerHTML = SITES.map(s=> `<option value="${s.id}">${s.id} — ${s.name}</option>`).join('');
}
function workerRow(w){
  const stato = sumQual(w)==='Qualificato'
    ? `<span class="chip green">Qualificato</span>` : `<span class="chip red">Non qualificato</span>`;
  const preposto = w.docs?.preposto ? '✔️' : '—';
  const anti     = w.docs?.antincendio ? '✔️' : '—';
  const ps       = w.docs?.primo_soccorso ? '✔️' : '—';
  const avanz    = (w.docs?.visita_medica || w.docs?.corso_generale || w.docs?.corso_specifica_fs || w.docs?.dpi_consegna)
                    ? `<span class="chip amber">Documentazione da completare</span>` : `<span class="chip red">Nessun documento</span>`;
  return `
  <tr>
    <td><b>${w.name}</b><div class="muted" style="font-size:12px">${w.cf||''}</div></td>
    <td>${w.role||'Operaio'}</td>
    <td>${stato}</td>
    <td style="text-align:center">${preposto}</td>
    <td style="text-align:center">${anti}</td>
    <td style="text-align:center">${ps}</td>
    <td>${avanz}</td>
    <td class="row">
      <button class="btn ghost" data-upload="${w.id}">Carica doc</button>
      <button class="btn secondary" data-edit="${w.id}">Modifica</button>
    </td>
  </tr>`;
}
function renderWorkers(){
  $('#workers-tbody').innerHTML = WORKERS.map(workerRow).join('');
  // handlers
  $('#workers-tbody').querySelectorAll('[data-upload]').forEach(b=>{
    b.onclick = ()=> openUpload(b.dataset.upload);
  });
}

/* ====== Site Detail ====== */
async function openSiteDetail(siteId){
  SD_SITE = SITES.find(s=> s.id===siteId);
  if(!SD_SITE){ toast('Cantiere non trovato'); return; }

  SD_WORKER_IDS = (SD_SITE.workers || []).map(w => (typeof w==='string' ? w : w.id));

  $('#sd-title').textContent = SD_SITE.name;
  $('#sd-id').textContent = SD_SITE.id;
  $('#sd-client').textContent = SD_SITE.client||'—';
  $('#sd-address').textContent = SD_SITE.address||'—';
  $('#sd-range').textContent = fmtRange(SD_SITE.dates?.start, SD_SITE.dates?.end);

  $('#sd-add-select').innerHTML = WORKERS
    .filter(w=> !SD_WORKER_IDS.includes(w.id))
    .map(w=> `<option value="${w.id}">${w.name} — ${w.role||'Operaio'}</option>`)
    .join('') || `<option value="">Nessun lavoratore disponibile</option>`;

  renderSdWorkers();
  renderSdPos();
  show('site-detail');
  selectSdTab('ovw');
}
function selectSdTab(code){
  $('#sd-tabs').querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===code));
  document.querySelectorAll('.sd-pane').forEach(p=> p.classList.toggle('hidden', p.dataset.pane!==code));
}
$('#sd-tabs').addEventListener('click', e=>{
  const a = e.target.closest('.tab'); if(!a) return; e.preventDefault();
  selectSdTab(a.dataset.tab);
});
$('#site-back').onclick = ()=> show('sites');

function renderSdWorkers(){
  const rows = SD_WORKER_IDS.map(id=>{
    const w = WORKERS.find(x=> x.id===id);
    if(!w) return '';
    const stato = sumQual(w)==='Qualificato'
      ? `<span class="chip green">Qualificato</span>` : `<span class="chip red">Non qualificato</span>`;
    const preposto = w.docs?.preposto ? '✔️' : '—';
    const anti     = w.docs?.antincendio ? '✔️' : '—';
    const ps       = w.docs?.primo_soccorso ? '✔️' : '—';
    const avanz    = (w.docs?.visita_medica || w.docs?.corso_generale || w.docs?.corso_specifica_fs || w.docs?.dpi_consegna)
                    ? `<span class="chip amber">Documentazione da completare</span>` : `<span class="chip red">Nessun documento</span>`;
    return `
      <tr>
        <td><b>${w.name}</b><div class="muted" style="font-size:12px">${w.cf||''}</div></td>
        <td>${w.role||'Operaio'}</td>
        <td>${stato}</td>
        <td style="text-align:center">${preposto}</td>
        <td style="text-align:center">${anti}</td>
        <td style="text-align:center">${ps}</td>
        <td>${avanz}</td>
        <td class="row">
          <button class="btn ghost" data-sd-upload="${w.id}">Carica doc</button>
          <button class="btn secondary" data-sd-remove="${w.id}">Rimuovi</button>
        </td>
      </tr>`;
  }).join('');
  $('#sd-workers').innerHTML = rows || `<tr><td colspan="8" class="muted">Nessun lavoratore assegnato</td></tr>`;

  // handlers
  $('#sd-workers').querySelectorAll('[data-sd-upload]').forEach(b=>{
    b.onclick = ()=> openUpload(b.dataset.sdUpload);
  });
  $('#sd-workers').querySelectorAll('[data-sd-remove]').forEach(b=>{
    b.onclick = ()=> sdRemoveWorker(b.dataset.sdRemove);
  });
}

$('#sd-add-btn').onclick = async ()=>{
  const id = $('#sd-add-select').value;
  if(!id){ toast('Seleziona un lavoratore'); return; }
  // tenta endpoint backend, altrimenti fallback locale
  let persisted = true;
  try{
    const r = await fetch(`${API_BASE}/sites/${SD_SITE.id}/workers`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: form({ worker_id:id })
    });
    if(!r.ok) throw 0;
  }catch(_){ persisted = false; }
  if(!SD_WORKER_IDS.includes(id)) SD_WORKER_IDS.push(id);
  renderSdWorkers(); renderSdPos();
  $('#sd-add-select').querySelector(`option[value="${id}"]`)?.remove();
  toast(persisted ? 'Lavoratore assegnato' : 'Assegnazione locale (aggiorna backend per persistere)');
};
async function sdRemoveWorker(id){
  try{ await fetch(`${API_BASE}/sites/${SD_SITE.id}/workers/${id}`, { method:'DELETE' }); }catch(_){}
  SD_WORKER_IDS = SD_WORKER_IDS.filter(x=> x!==id);
  renderSdWorkers(); renderSdPos();
  const w = WORKERS.find(x=> x.id===id);
  if(w){
    const opt = document.createElement('option');
    opt.value=w.id; opt.textContent=`${w.name} — ${w.role||'Operaio'}`;
    $('#sd-add-select').appendChild(opt);
  }
}

function renderSdPos(){
  const ws = WORKERS.filter(w=> SD_WORKER_IDS.includes(w.id));
  const txt = [
    `POS — Piano Operativo di Sicurezza`,
    `Site: ${SD_SITE.name} — ${SD_SITE.address||'—'}`,
    `Client: ${SD_SITE.client||'—'}`,
    `Period: ${fmtRange(SD_SITE.dates?.start, SD_SITE.dates?.end)}`,
    ``,
    `Workers:`,
    ...ws.map(w=> `- ${w.name} (${w.role||'Operaio'})`)
  ].join('\n');
  $('#sd-pos-preview').textContent = txt;
}
$('#sd-pos-generate').onclick = async ()=>{
  const ws = WORKERS.filter(w=> SD_WORKER_IDS.includes(w.id));
  const out = await fetchJSON(`${API_BASE}/pos`, { method:'POST', body: form({ site: SD_SITE, workers: ws }) });
  $('#sd-pos-url').href = out.url;
  $('#sd-pos-link').classList.remove('hidden');
  toast('PDF generato');
};
$('#sd-upload-btn').onclick = ()=>{
  const first = SD_WORKER_IDS[0] || WORKERS[0]?.id;
  if(!first){ toast('Nessun lavoratore'); return; }
  openUpload(first);
};

/* ============================
   5) DATA LOAD
============================= */
async function loadAll(){
  // Health (silenzioso)
  try{ await fetchJSON(`${API_BASE}/health`); }catch(_){}
  // Sites
  try{ SITES = await fetchJSON(`${API_BASE}/sites`); }catch(_){ SITES=[]; }
  // Workers
  try{ WORKERS = await fetchJSON(`${API_BASE}/workers`); }catch(_){ WORKERS=[]; }

  // KPI base
  $('#kpi-sites').textContent = SITES.length;
  // placeholder KPI: conteggio “non qualificati”
  const nonq = WORKERS.filter(w=> sumQual(w)!=='Qualificato').length;
  $('#kpi-noncompliant').textContent = nonq;
  $('#kpi-due').textContent = '—';

  // Render
  renderSites();
  renderWorkers();

  // OCR selects
  $('#ocr-worker').innerHTML = WORKERS.map(w=> `<option value="${w.id}">${w.name}</option>`).join('');
  // upload modal select
  $('#mu-worker').innerHTML = $('#ocr-worker').innerHTML;
}

/* ============================
   6) NAV
============================= */
$('.nav').addEventListener('click', e=>{
  const a = e.target.closest('a.tab'); if(!a) return;
  e.preventDefault(); show(a.dataset.view);
});

/* ============================
   7) ACTIONS & MODALS
============================= */
// New Site modal
$('#btn-new-site').onclick = ()=> openModal('#modal-site');
$('#btn-new-site-2').onclick = ()=> openModal('#modal-site');
document.querySelectorAll('[data-close]').forEach(b=>{
  b.onclick = ()=> closeModal(b.dataset.close);
});
$('#ms-create').onclick = async ()=>{
  const payload = {
    name: $('#ms-name').value.trim(),
    address: $('#ms-address').value.trim(),
    client: $('#ms-client').value.trim(),
    dates: { start: $('#ms-start').value || null, end: $('#ms-end').value || null },
    cse: { name: null, email: $('#ms-cse').value || null }
  };
  try{
    const s = await fetchJSON(`${API_BASE}/sites`, { method:'POST', body: form(payload) });
    SITES.push(s); renderSites(); closeModal('#modal-site'); toast('Cantiere creato');
  }catch(err){
    toast('Errore creazione cantiere'); console.error(err);
  }
};

// New Worker modal
$('#btn-new-worker').onclick = ()=> openModal('#modal-worker');
$('#mw-create').onclick = async ()=>{
  const payload = {
    name: $('#mw-name').value.trim(),
    cf: $('#mw-cf').value.trim(),
    role: $('#mw-role').value.trim() || 'Operaio'
  };
  try{
    const w = await fetchJSON(`${API_BASE}/workers`, { method:'POST', body: form(payload) });
    WORKERS.push(w); renderWorkers(); closeModal('#modal-worker'); toast('Lavoratore creato');
    // aggiorna selects vari
    $('#ocr-worker').innerHTML = WORKERS.map(w=> `<option value="${w.id}">${w.name}</option>`).join('');
    $('#mu-worker').innerHTML = $('#ocr-worker').innerHTML;
    renderSdPos();
  }catch(err){
    toast('Errore creazione lavoratore'); console.error(err);
  }
};

// Upload modal open (from workers table or site detail)
function openUpload(workerId){
  $('#mu-worker').value = workerId || WORKERS[0]?.id || '';
  $('#mu-file').value = '';
  $('#mu-out').textContent = '';
  openModal('#modal-upload');
}
$('#workers-tbody').addEventListener('click', e=>{
  const b = e.target.closest('[data-upload]'); if(!b) return;
  openUpload(b.dataset.upload);
});

async function doUpload(workerId, file){
  const fd = new FormData();
  fd.append('file', file);
  const r = await fetch(`${API_BASE}/workers/${workerId}/docs`, { method:'POST', body: fd });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

$('#mu-upload').onclick = async ()=>{
  const workerId = $('#mu-worker').value;
  const file = $('#mu-file').files[0];
  if(!workerId || !file){ toast('Seleziona lavoratore e file'); return; }
  try{
    const out = await doUpload(workerId, file);
    $('#mu-out').textContent = JSON.stringify(out, null, 2);
    toast('Documento caricato');
  }catch(err){
    toast('Errore upload'); console.error(err);
  }
};

// OCR page quick
$('#ocr-upload').onclick = async ()=>{
  const workerId = $('#ocr-worker').value;
  const f = $('#ocr-file').files[0];
  if(!f){ toast('Seleziona un file'); return; }
  try{
    const out = await doUpload(workerId, f);
    $('#ocr-out').textContent = JSON.stringify(out, null, 2);
    toast('Documento caricato');
  }catch(err){ toast('Errore upload'); console.error(err); }
};

// POS quick composer
$('#pos-generate').onclick = async ()=>{
  const siteId = $('#pos-site').value;
  const site = SITES.find(s=> s.id===siteId);
  const ws = WORKERS; // POS rapido: tutti
  const preview = [
    `POS — Piano Operativo di Sicurezza`,
    `Site: ${site.name} — ${site.address||'—'}`,
    `Client: ${site.client||'—'}`,
    `Period: ${fmtRange(site.dates?.start, site.dates?.end)}`,
    ``,
    `Workers:`,
    ...ws.map(w=> `- ${w.name} (${w.role||'Operaio'})`)
  ].join('\n');
  $('#pos-preview').textContent = preview;

  try{
    const out = await fetchJSON(`${API_BASE}/pos`, { method:'POST', body: form({ site, workers: ws }) });
    $('#pos-url').href = out.url;
    $('#pos-link').classList.remove('hidden');
    toast('PDF generato');
  }catch(err){ toast('Errore generazione POS'); console.error(err); }
};

/* ============================
   8) INIT
============================= */
loadAll();
</script>
</body>
</html>
